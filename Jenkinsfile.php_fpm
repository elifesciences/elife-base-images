elifePipeline {
    elifeOnNode(
        {
            def commit
            def tag
            stage 'Checkout', {
                checkout scm
                commit = elifeGitRevision()
                tag = elifeDateTimeTag()
            }

            stage 'Build image', {
                checkout scm
                sh 'docker build -f Dockerfile.php_fpm -t elifesciences/php_fpm .'
            }

            stage 'Sanity tests', {
                sh 'docker run -it elifesciences/php_fpm /usr/bin/env php -r "echo 42, PHP_EOL;"'
            }

            elifeMainlineOnly {
                stage 'Push image', {
                    sh "docker tag elifesciences/php_fpm:${tag} && docker push elifesciences/php_fpm:${tag}"
                    sh "docker tag elifesciences/php_fpm:latest && docker push elifesciences/php_fpm:latest"
                }
            }
        },
        'elife-libraries--ci'
    )
}
